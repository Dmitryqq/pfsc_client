(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-1315a27a"],{5505:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"commit view"},[s("Navbar"),t.isLoading?s("Loader"):s("div",{staticClass:"col-md-7 mx-auto my-5"},[t.error?s("div",{staticClass:"alert alert-danger",attrs:{role:"alert"}},[t._v("\n            "+t._s(t.error)+"\n        ")]):t._e(),t.success?s("div",{staticClass:"alert alert-success"},[t._v("\n            "+t._s(t.success)+"\n        ")]):t._e(),s("table",{staticClass:"table table-sm",class:{editMode:t.editMode}},[s("tr",[s("th",[t._v("Имя пользователя")]),s("td",[t._v(t._s(t.commit.userName))])]),s("tr",[s("th",[t._v("Дата")]),s("td",[t._v(t._s(t.commit.createDate))])]),s("tr",[s("th",[t._v("Статус")]),s("td",[s("span",{staticClass:"badge",class:t.getStatus(t.commit.status).color},[t._v(t._s(t.getStatus(t.commit.status).name))])])]),t.commit.mark?s("tr",[s("th",[t._v("Метка")]),t.editMode?s("td",[s("select",{directives:[{name:"model",rawName:"v-model",value:t.newCommit.markId,expression:"newCommit.markId"}],staticClass:"form-control form-control-sm col-lg-8",on:{change:function(e){var s=Array.prototype.filter.call(e.target.options,function(t){return t.selected}).map(function(t){var e="_value"in t?t._value:t.value;return e});t.$set(t.newCommit,"markId",e.target.multiple?s:s[0])}}},t._l(t.marks,function(e){return s("option",{key:e.id,domProps:{value:e.id}},[t._v(t._s(e.name))])}),0)]):s("td",[s("span",{staticClass:"badge badge-secondary"},[t._v(t._s(t.commit.mark.name))])])]):t._e(),s("tr",[s("th",[t._v("Описание")]),t.editMode?s("td",[s("textarea",{directives:[{name:"model",rawName:"v-model",value:t.newCommit.description,expression:"newCommit.description"}],staticClass:"form-control",attrs:{cols:"",rows:"7"},domProps:{value:t.newCommit.description},on:{input:function(e){e.target.composing||t.$set(t.newCommit,"description",e.target.value)}}})]):s("td",[t._v("\n                    "+t._s(t.commit.description)+"\n                ")])])]),t.editMode?s("div",{staticClass:"text-center"},[s("button",{staticClass:"btn btn-primary  my-3",on:{click:t.updateCommit}},[t._v("\n                Обновить\n            ")])]):t._e(),t._l(t.commit.fileTypes,function(e,i){return s("div",{key:e.id,staticClass:"card my-2"},[s("div",{staticClass:"card-header"},[t._v("\n                "+t._s(e.name)+"\n                "),e.required&&e.roleId==t.user.role.id?s("span",{staticClass:"text-danger"},[t._v("*")]):t._e(),e.files.length<e.maxAmount&&t.checkEnabled(e)?s("label",{staticClass:"icon-btn ml-3"},[s("input",{attrs:{type:"file",multiple:""},on:{change:function(e){return t.onFileChanged(e,i)}}}),s("i",{staticClass:"fas fa-plus"})]):t._e(),t.checkEnabled(e)?s("Popover",[t._v("\n                    maximum: "+t._s(e.maxAmount)+" file(s) "),s("br"),t._v("\n                    extensions: "+t._s(e.types)+"\n                ")]):t._e()],1),e.files.length?s("div",{staticClass:"card-body"},[s("table",{staticClass:"table table-sm table-borderless",staticStyle:{"margin-bottom":"0"}},t._l(e.files,function(a,o){return s("tr",{key:a.id},[s("td",[t._v(t._s(o+1))]),s("td",{staticClass:"file-link",on:{click:function(e){t.getFile(a.id,t.getFileName(a.path))}}},[t._v(t._s(t.getFileName(a.path)))]),s("td",{staticClass:"text-secondary",staticStyle:{"font-size":".8rem","vertical-align":"middle"}},[t._v(t._s(a.createDate))]),t.checkEnabled(e)?s("td",[s("label",{staticClass:"icon-btn",on:{click:function(e){return t.deleteFile(a,o,i)}}},[s("i",{staticClass:"fas fa-trash"})])]):t._e()])}),0)]):t._e()])}),t.isAdmin&&null==t.commit.status?s("div",{staticClass:"text-center my-4"},[s("button",{staticClass:"btn btn-primary mx-3",attrs:{type:"button"},on:{click:t.acceptCommit}},[t._v("Принять")]),s("button",{staticClass:"btn btn-danger mx-3",attrs:{type:"button"},on:{click:t.showModal}},[t._v("Отклонить")])]):t._e()],2),s("Modal",{ref:"myModal",attrs:{title:"Причина отклонения",button:"Отклонить"},on:{clickHandler:function(e){return t.confirm()}}},[s("div",{staticClass:"form-group"},[s("textarea",{directives:[{name:"model",rawName:"v-model",value:t.rejectMessage,expression:"rejectMessage"}],staticClass:"form-control",attrs:{cols:"",rows:"7"},domProps:{value:t.rejectMessage},on:{input:function(e){e.target.composing||(t.rejectMessage=e.target.value)}}})])])],1)},a=[],o=(s("28a5"),s("20d6"),s("d178")),n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"modal",attrs:{tabindex:"-1",role:"dialog",id:"thisModal"}},[s("div",{staticClass:"modal-dialog",attrs:{role:"document"}},[s("div",{staticClass:"modal-content"},[s("div",{staticClass:"modal-header"},[s("h5",{staticClass:"modal-title"},[t._v(t._s(t.title))]),t._m(0)]),s("div",{staticClass:"modal-body"},[t._t("default")],2),s("div",{staticClass:"modal-footer"},[s("button",{staticClass:"btn btn-secondary",attrs:{type:"button","data-dismiss":"modal"}},[t._v("Отмена")]),s("button",{staticClass:"btn btn-primary",attrs:{type:"button"},on:{click:t.clickHandler}},[t._v(t._s(t.button))])])])])])},r=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("button",{staticClass:"close",attrs:{type:"button","data-dismiss":"modal","aria-label":"Close"}},[s("span",{attrs:{"aria-hidden":"true"}},[t._v("×")])])}],c={name:"Modal",props:{title:String,button:String},methods:{clickHandler:function(){this.$emit("clickHandler"),this.hide()},show:function(){$("#thisModal").modal("show")},hide:function(){$("#thisModal").modal("hide")}}},m=c,l=s("2877"),d=Object(l["a"])(m,n,r,!1,null,null,null),u=d.exports,h=s("555f"),f=s("cc8d"),p=s("4be7"),g=s("5118"),v={name:"Commit",components:{Navbar:o["a"],Modal:u,Loader:h["a"],Popover:f["a"]},computed:{statuses:function(){return this.$store.state.commits.statuses},user:function(){return this.$store.state.users.user},roles:function(){return this.$store.state.roles.roles},marks:function(){return this.$store.state.marks.marks},isAdmin:function(){return this.user.role&&"Admin"==this.user.role.roleName}},methods:{getCommit:function(){var t=this;this.isLoading=!0,this.$store.dispatch("commits/getCommit",this.$route.params.id).then(function(e){t.commit=e,t.commit.userId==t.user.id&&null==t.commit.status&&(t.editMode=!0,t.getMarks(),t.newCommit.id=t.commit.id,t.newCommit.description=t.commit.description,t.newCommit.markId=t.commit.markId),t.$store.dispatch("commits/changeStatus",[t.commit.id,t.commit.status])}).catch(function(e){t.error=e.message}).finally(function(){t.isLoading=!1})},getRoles:function(){this.$store.dispatch("roles/getRoles")},getMarks:function(){this.$store.dispatch("marks/getMarks")},getStatus:function(t){var e=this.statuses.findIndex(function(e){return e.value==t});return e>=0?this.statuses[e]:""},getFileName:function(t){var e=t.split("\\");return e[e.length-1]},onFileChanged:function(t,e){var s=this;if(this.error="",this.success="",t.target.files.length>this.commit.fileTypes[e].maxAmount-this.commit.fileTypes[e].files.length)this.error="Количество файлов превышает допустимое число";else{this.isLoading=!0;for(var i=[],a=0;a<t.target.files.length;a++)i.push(t.target.files[a]);this.sendFiles(this.commit.fileTypes[e].id,i).then(function(){s.showSuccess("Файл(ы) успешно добавлен(ы)")}).catch(function(t){s.error=t.message}).finally(function(){s.getCommit(),s.isLoading=!1})}},sendFiles:function(t,e){var s=this;return new p["Promise"](function(i,a){var o=new FormData;o.append("commitId",s.commit.id),o.append("fileTypeId",t),e.map(function(t){o.append("file",t)}),s.$store.dispatch("commits/addFiles",o).then(function(){i()}).catch(function(t){a(t)})})},showModal:function(){this.error="",this.success="",this.$refs["myModal"].show()},confirm:function(){this.rejectCommit()},deleteFile:function(t,e,s){var i=this;confirm("Подтвердите удаление файла '"+this.getFileName(t.path)+"'")&&(this.isLoading=!0,this.$store.dispatch("commits/deleteFile",t.id).then(function(){i.commit.fileTypes[s].files.splice(e,1),i.showSuccess("Файл успешно удален")}).catch(function(t){i.getCommit(),i.error=t.message}).finally(function(){i.isLoading=!1}))},updateCommit:function(){var t=this;""!=this.newCommit.description?this.commit.description==this.newCommit.description&&this.commit.markId==this.newCommit.markId||confirm("Подтвердите обновление наката")&&(this.isLoading=!0,this.$store.dispatch("commits/updateCommit",this.newCommit).then(function(){t.showSuccess("Накат успешно обновлен")}).catch(function(e){t.getCommit(),t.error=e.message}).finally(function(){t.isLoading=!1})):this.error="Заполните поле описание!"},acceptCommit:function(){var t=this;confirm("Подтвердите принятие наката")&&(this.isLoading=!0,this.$store.dispatch("commits/acceptCommit",this.commit.id).then(function(){t.getCommit(),t.showSuccess("Накат успешно принят")}).catch(function(e){t.error=e.message}).finally(function(){t.isLoading=!1}))},rejectCommit:function(){var t=this;""!=this.rejectMessage?(this.isLoading=!0,this.$store.dispatch("commits/rejectCommit",[this.commit.id,this.rejectMessage]).then(function(){t.getCommit(),t.showSuccess("Накат успешно отклонен")}).catch(function(e){t.error=e.message}).finally(function(){t.isLoading=!1}),this.rejectMessage=""):this.error="Причина отказа не указана"},checkEnabled:function(t){if(this.roles){var e=this.roles.findIndex(function(e){return e.id==t.roleId});return(t.roleId==this.user.role.id||!this.roles[e]||"Admin"==this.user.role.roleName&&"User"!=this.roles[e].roleName)&&!(null!=this.commit.status&&!t.enableAfterAccept)}},getFile:function(t,e){this.$store.dispatch("commits/getFile",[t,e])},showSuccess:function(t){var e=this;this.success=t,Object(g["setTimeout"])(function(){e.success=null},3e3)}},data:function(){return{commit:{},error:"",success:"",editMode:!1,newCommit:{},rejectMessage:"",isLoading:!1}},mounted:function(){this.getCommit(),this.getRoles()}},C=v,_=(s("fbed"),Object(l["a"])(C,i,a,!1,null,null,null));e["default"]=_.exports},"993d":function(t,e,s){},fbed:function(t,e,s){"use strict";var i=s("993d"),a=s.n(i);a.a}}]);
//# sourceMappingURL=chunk-1315a27a.03c5d0b4.js.map